{% extends "layout.html" %}

{% block scripts %}
<script type="text/javascript">
  var deckPos = 0;
  var displayLanguage = 'chinese';
  var defaultLanguage = 'chinese';
  var deck;

  function updateDisplay() {
    var word = deck[deckPos];
    switch (displayLanguage) {
      case 'chinese':
        $('#display-word').html(word.chinese);
        break;          
      case 'pinyin':
        $('#display-word').html('(' + word.pinyin + ')');
        break;          
      case 'english':
        $('#display-word').html(word.english);
        break;          
      default:
        $('#display-word').html('wtf');
    }
    
    $('#progress').html('card ' + (deckPos+1) + ' of ' + deck.length);
    $('#wid').html('(wid:' + deck[deckPos].wid + ')');
  };

  function flipCard(reverse) {
    if (reverse) {
        switch (displayLanguage) {
          case 'chinese':
            displayLanguage = 'english';
            break;          
          case 'pinyin':
            displayLanguage = 'chinese';
            break;          
          case 'english':
            displayLanguage = 'pinyin';
            break;          
        }
    } else {
        switch (displayLanguage) {
          case 'chinese':
            displayLanguage = 'pinyin';
            break;          
          case 'pinyin':
            displayLanguage = 'english';
            break;          
          case 'english':
            displayLanguage = 'chinese';
            break;          
        }
    }
    updateDisplay();
  };

  function changeCard(next) {
    if (next) {
      deckPos = (deckPos + 1) % deck.length;
    } else {
      deckPos = (deckPos + deck.length - 1) % deck.length;
    }
    displayLanguage = defaultLanguage;
    updateDisplay();
  }

  function changeLanguage(newLanguage) {
    if (newLanguage == '') {
      switch (defaultLanguage) {
        case 'chinese':
          defaultLanguage = 'pinyin';
          break;
        case 'pinyin':
          defaultLanguage = 'english';
          break;
        case 'english':
          defaultLanguage = 'chinese';
          break;
      }
    } else {
      defaultLanguage = newLanguage;
    }
    $('#language-button').html(defaultLanguage);
    displayLanguage = defaultLanguage;
    updateDisplay();
  }

  function loadDeck() {
    $.get("/api/words", 
      function(words) {
        deck = words;
        deckPos = 0;
        changeLanguage(newLanguage = defaultLanguage);
        updateDisplay();
      }
    );
  }

  function shuffleDeck() {
    var j, tmp, i;
    for (i = deck.length; i > 0; i--) {
        j = Math.floor(Math.random() * i);
        tmp = deck[i - 1];
        deck[i - 1] = deck[j];
        deck[j] = tmp;
    }
    deckPos = 0;
    updateDisplay();
  }

  function popCard() {
    if (deck.length > 1) {
      deck.splice(deckPos,1);
      deckPos = deckPos % deck.length;
      updateDisplay();
    }
  }

  $(document).ready(function() {
    loadDeck();

    $('.flash-card-word').click(function() { flipCard(); });
    $('#prev-word').click(function() { changeCard(next=false); });
    $('#next-word').click(function() { changeCard(next=true); });
    $('#language-button').click(function() { changeLanguage(''); });
    $('#reload-button').click(function() { loadDeck(); });
    $('#shuffle-button').click(function() { shuffleDeck(); });
    $('#remove-card-button').click(function() { popCard(); });
  });

  $(document).keyup(function(e) {
    switch (e.which) {
      case 37: // left
        changeCard(next=false);
        break;
      case 39: // right
        changeCard(next=true);
        break;
      case 38: // up
        flipCard(reverse=true);
        break;
      case 40: // down
        flipCard(reverse=false);
        break;
      case 82: // r
        loadDeck();
        break;
      case 83: // s
        shuffleDeck();
        break;
      case 76: // l
        if (e.shiftKey) {
          changeLanguage('');
        }
        break;
      case 67: // c
        if (e.shiftKey) {
          changeLanguage('chinese');
        }
        break;
      case 69: // e
        if (e.shiftKey) {
          changeLanguage('english');
        }
        break;
      case 80: // p
        if (e.shiftKey) {
          changeLanguage('pinyin');
        }
        break;
      case 88: // x
        if (e.shiftKey) {
          popCard(); 
        }
        break;
      default:
        return;
    }
  });
</script>
{% endblock %}

{% block title %}
    <span id="language-button" class="button title-bar-button"></span>
    <span id="shuffle-button" class="button title-bar-button"><s></s>shuffle</span>
    <span id="reload-button" class="button title-bar-button"><s></s>reload</span>
{% endblock %}

{% block content %}
  <div id="flash-card" class="flash-card">
    <span id="prev-word" class="navigation-button-prev"></span>
    <span id="next-word" class="navigation-button-next"></span>
    <div class="flash-card-word">
      <span id="display-word" class="translation"></span>
    </div>
    <div class="card-status-bar">
      <div class="stats">
        <span id="progress"></span>
        <span id="wid"></span>
      </div>
      <span id="remove-card-button" class="button card-button">remove card</span>
    </div>
  </div>
{% endblock %}